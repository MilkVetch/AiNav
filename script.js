/**
 * ÁΩëÂùÄÂØºËà™Ê†∏ÂøÉÈÄªËæë - 2025 ÂÖ®Êñ∞ÂÆåÊï¥‰øÆÂ§çÁâà
 * ÂäüËÉΩÔºöÂèåËØ≠ I18N„ÄÅÂä®ÊÄÅÊó∂Èó¥„ÄÅGist ‰∫ëÁ´ØÂêåÊ≠•„ÄÅÂ§öÈù¢ÊùøÂàáÊç¢„ÄÅÂºπÁ™óÂä®ÁîªÈöîÁ¶ª
 */

// 1. ÂõΩÈôÖÂåñÈÖçÁΩÆ (I18N)
const I18N = {
    zh: {
        navBrand: "ÁΩëÂùÄÂØºËà™", searchPlaceholder: "ÊêúÁ¥¢ÊàñËæìÂÖ•ÁΩëÂùÄ...", addSite: "+ ÁΩëÂùÄ", addCat: "+ ÂàÜÁ±ª", settings: "Setup",
        modalTitleSettings: "Setup", menuLang: "ËØ≠Ë®ÄËÆæÁΩÆ", menuBoard: "Èù¢ÊùøÁÆ°ÁêÜ", menuSetup: "ÈÖçÁΩÆ‰∏≠ÂøÉ", 
        labelSwitchBoard: "ÂàáÊç¢Èù¢Êùø", labelRenameBoard: "Èù¢ÊùøÊõ¥Âêç", btnApply: "Â∫îÁî®", btnNew: "+ Êñ∞Â¢û", btnDel: "Âà†Èô§", 
        btnSave: "‰øùÂ≠òÂπ∂ÂêåÊ≠•", modalTitleSite: "Êñ∞Â¢ûÁΩëÂùÄ", labelSelectCat: "ÈÄâÊã©ÂàÜÁ±ª", labelSiteName: "ÂêçÁß∞", 
        labelSiteUrl: "ÁΩëÂùÄ", btnConfirm: "Á°ÆËÆ§Ê∑ªÂä†", modalTitleCat: "Êñ∞Â¢ûÂàÜÁ±ª", labelCatName: "ÂàÜÁ±ªÂêçÁß∞", 
        setupBtn: "ÂºÄÂßãÈÖçÁΩÆ", emptyBoard: "ÂàõÂª∫È¶ñ‰∏™Èù¢Êùø", confirmDelSite: "Á°ÆËÆ§Âà†Èô§ÁΩëÂùÄÔºü", 
        confirmDelCat: "Á°ÆËÆ§Âà†Èô§ÂàÜÁ±ªÔºü", confirmReset: "Êñ≠ÂºÄ‰∫ëÁ´ØËøûÊé•Ôºü", promptNewBoard: "ËæìÂÖ•Êñ∞Èù¢ÊùøÂêçÁß∞Ôºö",
        introTitle: "Ëøô‰∏™ÂØºËà™Á´ôËÉΩÂÅö‰ªÄ‰πàÔºü",
        introDesc: "Âü∫‰∫é GitHub Gist ÁöÑÊûÅÁÆÄÂØºËà™„ÄÇÊï∞ÊçÆ 100% Â≠òÂÇ®Âú®ÊÇ®ÁöÑÁßÅÊúâË¥¶Âè∑‰∏≠„ÄÇ",
        feature1: "Â§öÈù¢ÊùøÊîØÊåÅÔºöÊåâÈúÄÂàÜÁ±ªÔºåÂú∫ÊôØÂàáÊç¢„ÄÇ",
        feature2: "‰∫ëÁ´ØÂêåÊ≠•ÔºöÁîµËÑë‰∏éÊâãÊú∫ÊµèËßàÂô®ÂÆûÊó∂Êó†ÁºùÂêåÊ≠•„ÄÇ",
        feature3: "Á∫ØÂáÄÈöêÁßÅÔºöÊó†ËøΩË∏™ÔºåÊûÅÈÄüÂìçÂ∫î„ÄÇ",
        tutorialTitle: "Âª∫ËÆÆÈÖçÁΩÆÊïôÁ®ã",
        tutorialStep1: "1. ËÆøÈóÆ GitHub ËÆæÁΩÆÔºåÂàõÂª∫‰∏Ä‰∏™ Fine-grained Token„ÄÇ",
        tutorialStep2: "2. ÊùÉÈôêÔºöÂøÖÈ°ªÂãæÈÄâ Gists ÁöÑËØªÂÜôÊùÉÈôê„ÄÇ",
        tutorialStep3: "3. Êñ∞Âª∫‰∏Ä‰∏™ GistÔºåÂåÖÂê´Êñá‰ª∂ ainav.json„ÄÇ",
        copyJsonBtn: "Â§çÂà∂ÂàùÂßãÂåñ JSON",
        copySuccess: "Â∑≤Â§çÂà∂ÔºÅ"
    },
    en: {
        navBrand: "Nav Hub", searchPlaceholder: "Search...", addSite: "+ Site", addCat: "+ Category", settings: "Setup",
        modalTitleSettings: "Setup", menuLang: "Language", menuBoard: "Boards", menuSetup: "Setup", 
        labelSwitchBoard: "Switch", labelRenameBoard: "Rename", btnApply: "Apply", btnNew: "+ New", btnDel: "Delete", 
        btnSave: "Save & Sync", modalTitleSite: "Add Site", labelSelectCat: "Category", labelSiteName: "Name", 
        labelSiteUrl: "URL", btnConfirm: "Confirm", modalTitleCat: "Add Category", labelCatName: "Name", 
        setupBtn: "Setup Now", emptyBoard: "Create Board", confirmDelSite: "Delete?", 
        confirmDelCat: "Delete category?", confirmReset: "Reset config?", promptNewBoard: "Name:",
        introTitle: "What is this?",
        introDesc: "A minimal dashboard powered by GitHub Gist. 100% private data storage.",
        feature1: "Multi-Boards: Organize Work and Life.",
        feature2: "Cloud Sync: Sync between PC and Mobile.",
        feature3: "Privacy: No ads, zero tracking.",
        tutorialTitle: "Setup Guide",
        tutorialStep1: "1. Create a Fine-grained Token in GitHub.",
        tutorialStep2: "2. Perms: Grant Gists read/write access.",
        tutorialStep3: "3. Create a Gist with ainav.json file.",
        copyJsonBtn: "Copy Initial JSON",
        copySuccess: "Copied!"
    }
};

// 2. ÂèåËØ≠ÈóÆÂÄôËØ≠
const GREETINGS = {
    zh: { "00:00": "ÂçàÂ§úÊó∂ÂàÜÔºåÁÅµÊÑüËøõÂèëÁöÑÊó∂Âàª„ÄÇ", "05:00": "Ê∏ÖÊô®Â•ΩÔºåÊñ∞ÁöÑ‰∏ÄÂ§©ÂºÄÂßã‰∫Ü„ÄÇ", "08:00": "Êó©ÂÆâÔºåÂºÄÂêØÈ´òÊïàÁöÑ‰∏ÄÂ§©„ÄÇ", "12:00": "‰∏≠ÂçàÂ•ΩÔºåËÆ∞ÂæóÂçà‰ºë‰∏Ä‰∏ã„ÄÇ", "14:00": "‰∏ãÂçàÂ•ΩÔºå‰øùÊåÅ‰∏ìÊ≥®„ÄÇ", "18:00": "ÂÇçÊôöÂ•ΩÔºå‰∫´ÂèóËêΩÊó•‰ΩôÊôñ„ÄÇ", "21:00": "Â§úÊ∑±‰∫ÜÔºåÈü≥‰πêÊòØÁÅµÈ≠ÇÁöÑÊ∏ØÊπæ„ÄÇ", "23:00": "ÊôöÂÆâÔºåÂÅö‰∏™Â•ΩÊ¢¶„ÄÇ" },
    en: { "00:00": "Midnight inspiration.", "05:00": "A new day begins.", "08:00": "Good morning, stay focused.", "12:00": "Take a short break.", "14:00": "Good afternoon.", "18:00": "Enjoy the sunset.", "21:00": "Music for the soul.", "23:00": "Good night, sweet dreams." }
};

// 3. Ê†∏ÂøÉÁä∂ÊÄÅ
let db = { activeIndex: 0, boards: [], lang: 'en' };
let isConfigured = false;
const CONFIG = { token: localStorage.getItem('gh_token'), gistId: localStorage.getItem('gh_gist_id') };

// 4. ÂàùÂßãÂåñÂÖ•Âè£
function init() {
    updateClock(); 
    setInterval(updateClock, 1000);
    
    // ÂàùÂßãÂåñÁä∂ÊÄÅÂ∞èÁÅØ‰∏∫Êñ≠ÂºÄÁä∂ÊÄÅ
    updateStatus(false);

    if (CONFIG.token && CONFIG.gistId) {
        fetchData();
    } else {
        render(); // Êú™ÈÖçÁΩÆÊó∂ÊòæÁ§∫ÂºïÂØºÈ°µ
    }
    lucide.createIcons();
}

// 5. Âä®ÊÄÅÊõ¥Êñ∞ÔºöÊó∂Èó¥„ÄÅËÉåÊôØ„ÄÅÈóÆÂÄôËØ≠
function updateClock() {
    const now = new Date();
    const h = now.getHours(), m = now.getMinutes();
    
    // Êï∞Â≠óÊó∂Èíü
    document.getElementById('digitalClock').innerText = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;

    // ËÉåÊôØÂÖâÊôïÈöèÊó∂Èó¥ÂèòÂåñ
    let glow = "rgba(150, 100, 255, 0.12)"; 
    if (h >= 5 && h < 12) glow = "rgba(255, 180, 100, 0.12)"; 
    else if (h >= 12 && h < 18) glow = "rgba(100, 200, 255, 0.12)"; 
    document.documentElement.style.setProperty('--glow-color', glow);

    // ÂèåËØ≠ÈóÆÂÄô
    const greetingEl = document.getElementById('greetingText');
    const lang = db.lang || 'en';
    const hourKeys = Object.keys(GREETINGS[lang]).sort().reverse();
    const currentKey = hourKeys.find(key => h >= parseInt(key.split(':')[0])) || "00:00";
    const target = GREETINGS[lang][currentKey];

    if (greetingEl.innerText !== target) {
        greetingEl.style.opacity = "0";
        setTimeout(() => {
            greetingEl.innerText = target;
            greetingEl.style.opacity = "1";
        }, 600);
    }
}

// 6. Êï∞ÊçÆÂ±ÇÔºöGist ÊãâÂèñ
async function fetchData() {
    try {
        const res = await fetch(`https://api.github.com/gists/${CONFIG.gistId}`, {
            headers: { 'Authorization': `token ${CONFIG.token}` }
        });
        if (!res.ok) throw new Error();
        const gist = await res.json();
        const content = JSON.parse(gist.files['ainav.json'].content);
        
        // ÂÖºÂÆπÂ§ÑÁêÜ
        db = content.categories ? { activeIndex: 0, boards: [{ title: "Main", categories: content.categories }], lang: content.lang || 'en' } : content;

        isConfigured = true;
        updateStatus(true);
        render();
    } catch (err) {
        isConfigured = false;
        render();
    }
}

// 7. Ê†∏ÂøÉÊ∏≤ÊüìÂáΩÊï∞
function render() {
    const dict = I18N[db.lang || 'en'];
    
    // Âü∫Á°ÄÊñáÊú¨Êõ¥Êñ∞
    document.getElementById('navBrandText').innerText = dict.navBrand;
    document.getElementById('btnSettingsText').innerText = dict.settings;
    document.getElementById('searchInput').placeholder = dict.searchPlaceholder;
    document.getElementById('menuLangText').innerText = dict.menuLang;
    document.getElementById('menuSetupText').innerText = dict.menuSetup;
    document.getElementById('modalTitleSettings').innerText = dict.modalTitleSettings;

    const app = document.getElementById('app');

    // ÊÉÖÂÜµ AÔºöÊú™ÈÖçÁΩÆÁä∂ÊÄÅ - ÊòæÁ§∫ÂºïÂØºÈ°µ
    if (!isConfigured) {
        document.getElementById('searchBarArea').classList.add('hide');
        document.getElementById('menuBoardItem').classList.add('hide');
        document.getElementById('menuBoardDivider').classList.add('hide');
        document.getElementById('addSiteBtn').classList.add('hide');
        document.getElementById('addCatBtn').classList.add('hide');

        app.innerHTML = `
            <div class="welcome-container">
                <div class="welcome-card">
                    <h4>‚ú® ${dict.introTitle}</h4>
                    <p>${dict.introDesc}</p>
                    <ul>
                        <li>${dict.feature1}</li>
                        <li>${dict.feature2}</li>
                        <li>${dict.feature3}</li>
                    </ul>
                    <button class="save-btn" onclick="handleOpenSetup()">
                        <i data-lucide="settings" class="icon-sm"></i> ${dict.setupBtn}
                    </button>
                </div>
                <div class="welcome-card">
                    <h4>üìñ ${dict.tutorialTitle}</h4>
                    <div class="tutorial-steps-wrapper">
                        <div class="tutorial-step">${dict.tutorialStep1}</div>
                        <div class="tutorial-step">${dict.tutorialStep2}</div>
                        <div class="tutorial-step">${dict.tutorialStep3}</div>
                    </div>
                    <button class="glass-btn" id="copyBtn" onclick="copyInitialJSON()">
                        <i data-lucide="copy" class="icon-sm"></i> ${dict.copyJsonBtn}
                    </button>
                </div>
            </div>
        `;
        lucide.createIcons();
        return;
    }

    // ÊÉÖÂÜµ BÔºöÂ∑≤ÈÖçÁΩÆÁä∂ÊÄÅ - ÊòæÁ§∫ÂØºËà™‰∏ªÂå∫
    document.getElementById('searchBarArea').classList.remove('hide');
    document.getElementById('menuBoardItem').classList.remove('hide');
    document.getElementById('menuBoardDivider').classList.remove('hide');
    document.getElementById('addSiteBtn').classList.remove('hide');
    document.getElementById('addCatBtn').classList.remove('hide');
    document.getElementById('addSiteBtn').innerText = dict.addSite;
    document.getElementById('addCatBtn').innerText = dict.addCat;

    const board = db.boards[db.activeIndex] || db.boards[0];

    if (!board) {
        app.innerHTML = `<button class="save-btn" style="max-width:240px; margin: 2rem auto;" onclick="createNewBoard()">${dict.emptyBoard}</button>`;
        return;
    }

    // ËÆæÁΩÆËèúÂçïÊñáÊú¨ÂêåÊ≠•
    document.getElementById('menuBoardText').innerText = dict.menuBoard;
    document.getElementById('labelSwitchBoard').innerText = dict.labelSwitchBoard;
    document.getElementById('labelRenameBoard').innerText = dict.labelRenameBoard;
    document.getElementById('btnSaveConfig').innerText = dict.btnSave;

    // Ê∏≤ÊüìÁúãÊùøÂÜÖÂÆπ
    document.getElementById('boardSwitcher').innerHTML = db.boards.map((b, i) => 
        `<option value="${i}" ${i==db.activeIndex?'selected':''}>${b.title}</option>`
    ).join('');
    
    app.innerHTML = '';
    const catSelect = document.getElementById('targetCat');
    catSelect.innerHTML = '';

    board.categories.forEach((cat, cIdx) => {
        catSelect.innerHTML += `<option value="${cIdx}">${cat.name}</option>`;
        const section = document.createElement('section');
        section.innerHTML = `
            <div class="category-header">
                <span>${cat.name}</span>
                <button class="close-btn" style="font-size:0.8rem" onclick="deleteCat(${cIdx})">
                    <i data-lucide="trash-2" class="chevron-icon"></i>
                </button>
            </div>
            <div class="board-grid" id="cat-${cIdx}"></div>
        `;
        app.appendChild(section);

        cat.sites.forEach((site, sIdx) => {
            let domain = 'invalid';
            try { domain = new URL(site.url).hostname; } catch(e) {}
            document.getElementById(`cat-${cIdx}`).innerHTML += `
                <a href="${site.url}" target="_blank" class="link-card">
                    <button class="del-site-btn" onclick="event.preventDefault(); deleteSite(${cIdx}, ${sIdx})">
                        &times;
                    </button>
                    <img src="https://www.google.com/s2/favicons?sz=128&domain=${domain}" onerror="this.src='https://lucide.dev/favicon.ico'">
                    <span>${site.name}</span>
                </a>
            `;
        });
    });
    lucide.createIcons();
}

// 8. ÂºπÁ™ó‰∏éËÆæÁΩÆÈ°µÈÄªËæë
function openCustomModal(id) { 
    document.getElementById('modalOverlay').classList.add('active'); 
    document.getElementById(id).classList.add('active'); 
    if(id==='settingsModal') {
        document.getElementById('ghToken').value = CONFIG.token || '';
        document.getElementById('gistId').value = CONFIG.gistId || '';
    }
}

function closeAllModals() {
    document.getElementById('modalOverlay').classList.remove('active');
    document.querySelectorAll('.custom-modal').forEach(m => m.classList.remove('active'));
    setTimeout(showSettingsHome, 300);
}

function handleOpenSettings() { 
    openCustomModal('settingsModal'); 
}

function handleOpenSetup() { 
    openCustomModal('settingsModal'); 
    showSettingPage('pageSetup'); 
}

function showSettingPage(pageId) {
    document.getElementById('settingsHome').classList.add('hide');
    document.querySelectorAll('.setting-detail-page').forEach(p => p.classList.add('hide'));
    document.getElementById(pageId).classList.remove('hide');
    document.getElementById('settingsBackBtn').classList.remove('hide');
}

function showSettingsHome() {
    document.getElementById('settingsHome').classList.remove('hide');
    document.querySelectorAll('.setting-detail-page').forEach(p => p.classList.add('hide'));
    document.getElementById('settingsBackBtn').classList.add('hide');
}

// 9. Ê†∏ÂøÉÂäüËÉΩÂáΩÊï∞
function setLanguage(lang) {
    db.lang = lang;
    render();
    if (isConfigured) pushToGist();
}

function saveSettings() {
    const token = document.getElementById('ghToken').value.trim();
    const id = document.getElementById('gistId').value.trim();
    if (token) localStorage.setItem('gh_token', token);
    if (id) localStorage.setItem('gh_gist_id', id);
    location.reload();
}

async function pushToGist() {
    if (!isConfigured) return;
    try {
        await fetch(`https://api.github.com/gists/${CONFIG.gistId}`, {
            method: 'PATCH',
            headers: { 'Authorization': `token ${CONFIG.token}` },
            body: JSON.stringify({ files: { 'ainav.json': { content: JSON.stringify(db, null, 2) } } })
        });
        updateStatus(true);
    } catch (e) { updateStatus(false); }
}

function copyInitialJSON() {
    const data = { activeIndex: 0, lang: "en", boards: [] };
    navigator.clipboard.writeText(JSON.stringify(data, null, 2)).then(() => {
        const btn = document.getElementById('copyBtn');
        const originalText = btn.innerText;
        btn.innerText = I18N[db.lang||'en'].copySuccess;
        setTimeout(() => { btn.innerText = originalText; }, 2000);
    });
}

function confirmReset() {
    if (confirm(I18N[db.lang||'en'].confirmReset)) {
        localStorage.clear();
        location.reload();
    }
}

// 10. ËæÖÂä©ÂäüËÉΩ (CRUD)
function addItem() {
    let url = document.getElementById('siteUrl').value.trim();
    if (url && !/^https?:\/\//i.test(url)) url = 'https://' + url;
    const cIdx = document.getElementById('targetCat').value;
    const n = document.getElementById('siteName').value;
    if (cIdx !== "" && n && url) {
        db.boards[db.activeIndex].categories[cIdx].sites.push({ name: n, url: url });
        closeAllModals(); render(); pushToGist();
    }
}

function addCategory() {
    const n = document.getElementById('catName').value.trim();
    if(n) { db.boards[db.activeIndex].categories.push({name: n, sites: []}); render(); pushToGist(); closeAllModals(); }
}

function createNewBoard() {
    const n = prompt(I18N[db.lang||'en'].promptNewBoard);
    if(n) { db.boards.push({title: n, categories: []}); db.activeIndex = db.boards.length - 1; render(); pushToGist(); }
}

function renameBoard() {
    const n = document.getElementById('siteTitleInput').value.trim();
    if(n) { db.boards[db.activeIndex].title = n; render(); pushToGist(); }
}

function deleteCurrentBoard() {
    if(confirm("Confirm Delete Board?")) { db.boards.splice(db.activeIndex, 1); db.activeIndex = 0; render(); pushToGist(); }
}

function deleteSite(c, s) { if(confirm("Delete site?")) { db.boards[db.activeIndex].categories[c].sites.splice(s,1); render(); pushToGist(); } }
function deleteCat(i) { if(confirm("Delete category?")) { db.boards[db.activeIndex].categories.splice(i,1); render(); pushToGist(); } }

function switchBoard(i) { db.activeIndex = parseInt(i); render(); pushToGist(); }

function updateStatus(on) {
    const dot = document.getElementById('syncStatus');
    if (dot) dot.className = `status-dot ${on ? 'status-online' : ''}`;
}

function handleSearch(e) {
    if (e.key === 'Enter') {
        const q = e.target.value;
        window.open(q.includes('.') ? (q.startsWith('http') ? q : 'https://'+q) : 'https://www.google.com/search?q='+encodeURIComponent(q));
    }
}

// ÂêØÂä®Á®ãÂ∫è
init();